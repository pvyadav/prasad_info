using DocumentFormat.OpenXml.Packaging;
using DocumentFormat.OpenXml.Spreadsheet;
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Windows.Forms;
using Excel = Microsoft.Office.Interop.Excel;

namespace RayKor.Add_In.TimeSheetValidation
{
    public partial class TimeSheetValidationForm : Form
    {
        private string LObjfilename;

        public TimeSheetValidationForm()
        {
            InitializeComponent();
        }

        public void validefilecollection()
        {
            DateTime LObjDate;
            LObjDate = dateTimePicker1.Value;
            string LobjDatePickrr = LObjDate.ToString().Replace("/", "");
            string lobjStr;
            List<string> LobjFilesCollection = new List<string>();
            DirectoryInfo LobjDirectory = new DirectoryInfo(@"D:\demo");// DEmo is your Folder
            FileInfo[] LobjFiles = LobjDirectory.GetFiles("*.xlsx");
            //Getting Text files
            foreach (FileInfo Lobjfile in LobjFiles)
            {
              lobjStr = Lobjfile.Name;
               string Fnameobject = lobjStr.Replace(" ", "").Replace("-", "");
                if(Fnameobject.Contains(LobjDatePickrr))
                {
                    LobjFilesCollection.Add(lobjStr);
                }
                else
                {

                }
                
             
            }
        }
        public Excel.Workbook PobjwbkWorkbook1 { get; private set; }

        private void button2_Click(object sender, EventArgs e)
        {
            DirectoryInfo LobjDirectory = new DirectoryInfo(@"D:\demo");// DEmo is your Folder
            FileInfo[] LobjFiles = LobjDirectory.GetFiles("*.xlsx"); //Getting Text files
            string lobjStr = "";
            string LobjvalideFolder = @"D:\Timesheetfolders\ValideFile\";
            string LobjINvalideFolder = @"D:\Timesheetfolders\Notvalidefile\";
            int count = 0;
            foreach (FileInfo Lobjfile in LobjFiles)
            {
                lobjStr = Lobjfile.Name;
                count++;
                textBox1.Text = "";
                textBox1.Text += count;
                ////Microsoft.Office.Interop.Excel.Application excelApp = new Microsoft.Office.Interop.Excel.Application();
                ////Workbook excelWorkBook = excelApp.Workbooks.Open(file.FullName);
                ////Worksheet excelWorkSheet = excelWorkBook.Sheets.Item[0];


                PobjwbkWorkbook1 = Globals.ThisAddIn.Application.Workbooks.Open(lobjStr, Editable: true,UpdateLinks:true,Local:true,AddToMru:true);
                Microsoft.Office.Interop.Excel.Worksheet LobjactiveSheet = Globals.ThisAddIn.Application.ActiveSheet as Microsoft.Office.Interop.Excel.Worksheet;
                 LobjactiveSheet.Visible = Excel.XlSheetVisibility.xlSheetVisible;
                var LCobj = LobjactiveSheet.Range["D3", Type.Missing].Value.Replace(" ", "");
                var Dobj = LobjactiveSheet.Range["L3", Type.Missing].Text.Replace("/", "");
                string Fnameobject = lobjStr.Replace(" ", "").Replace("-", "");
                if (Fnameobject.Contains(LCobj) && Fnameobject.Contains(Dobj))
                {
                    int LobjINvFileCount = 0;
                    DateTime LObjDate;
                    LObjDate = dateTimePicker1.Value;
                    string LobjDatePickrr = LObjDate.ToString().Replace("/", "");
                    if (LobjDatePickrr.Contains(Dobj))
                    {

                        var Lobjtoday = DateTime.Today;
                        var lobjmonth = new DateTime(Lobjtoday.Year, Lobjtoday.Month, 1);
                        string first = lobjmonth.AddMonths(-1).ToString("MM/dd/yy");
                        var LobjLastmonthdate = lobjmonth.AddDays(-1).ToString("MM/dd/yy");// last Monnth last date for validatting the curren 
                        var Dobjmon = LobjactiveSheet.Range["G7", Type.Missing].Text;
                        var Dobjtue = LobjactiveSheet.Range["H7", Type.Missing].Text;
                        var Dobjwen = LobjactiveSheet.Range["I7", Type.Missing].Text;
                        var Dobjthu = LobjactiveSheet.Range["J7", Type.Missing].Text;
                        var Dobjfri = LobjactiveSheet.Range["K7", Type.Missing].Text;
                        var lobjTotalBillableHours = LobjactiveSheet.Range["M17", Type.Missing].Value;
                        var lobjTotalNonBillableHours = LobjactiveSheet.Range["M29", Type.Missing].Value;
                        var LObjtotalHours = lobjTotalBillableHours + lobjTotalNonBillableHours;
                        //sum cell 
                        if (LobjLastmonthdate.Contains(Dobjmon))
                        {
                            if (LObjtotalHours == 32)
                            {
                                File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                System.Windows.Forms.MessageBox.Show("your Working Hours " + LObjtotalHours);
                            }
                            else
                            {
                                File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                                System.Windows.Forms.MessageBox.Show(" your Working Hours " + LObjtotalHours);
                            }
                        }
                        else if (LobjLastmonthdate.Contains(Dobjtue))
                        {
                            if (LObjtotalHours == 24)
                            {
                                File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                System.Windows.Forms.MessageBox.Show("your Working Hours " + LObjtotalHours);
                            }
                            else
                            {
                                File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                                System.Windows.Forms.MessageBox.Show(" your Working Hours " + LObjtotalHours);
                            }

                        }
                        else if (LobjLastmonthdate.Contains(Dobjwen))
                        {
                            if (LObjtotalHours == 16)
                            {
                                File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                System.Windows.Forms.MessageBox.Show("your Working Hours " + LObjtotalHours);
                            }
                            else
                            {
                                File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                                System.Windows.Forms.MessageBox.Show(" your Working Hours " + LObjtotalHours);
                            }

                        }
                        else if (LobjLastmonthdate.Contains(Dobjthu))
                        {
                            if (LObjtotalHours == 8)
                            {
                                File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                System.Windows.Forms.MessageBox.Show("your Working Hours " + LObjtotalHours);
                            }
                            else
                            {
                                File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                                System.Windows.Forms.MessageBox.Show(" your Working Hours " + LObjtotalHours);
                            }

                        }
                        else if (LobjLastmonthdate.Contains(Dobjfri))
                        {
                            if (LObjtotalHours == 40)
                            {
                                File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                System.Windows.Forms.MessageBox.Show("your Working Hours " + LObjtotalHours);
                            }
                            else
                            {
                                File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                                System.Windows.Forms.MessageBox.Show(" your Working Hours " + LObjtotalHours);
                            }
                        }
                        else if (!LobjLastmonthdate.Contains(Dobjmon) | !LobjLastmonthdate.Contains(Dobjtue) || !LobjLastmonthdate.Contains(Dobjwen) || !LobjLastmonthdate.Contains(Dobjthu) || !LobjLastmonthdate.Contains(Dobjfri))
                        {
                            if (LObjtotalHours == 40)
                            {
                                File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                //System.Windows.Forms.MessageBox.Show("your Working Hours " + LObjtotalHours);
                            }
                            else
                            {
                                File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                                //System.Windows.Forms.MessageBox.Show(" your Working Hours " + LObjtotalHours);
                            }
                        }
                        else
                        {
                            File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                        }
                    }
                    else { File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr)); }

                }



                
            }
            INvalide();
            valide();
        }

        //public static System.Data.DataTable ExportDataExcelToDataTable(String PobjPath)
        //{
        //    System.Data.DataTable LobjDataTable = new System.Data.DataTable();
        //    using (SpreadsheetDocument LobjSpreadsheetDocument = SpreadsheetDocument.Open(PobjPath, false))
        //    {
        //        string LsRelationshipId = LobjSpreadsheetDocument.WorkbookPart.Workbook.Descendants<Sheet>().FirstOrDefault().Id;
        //        WorksheetPart LobjWorksheetPart = (WorksheetPart)LobjSpreadsheetDocument.WorkbookPart.GetPartById(LsRelationshipId);
        //        SheetData LobjSheetData = LobjWorksheetPart.Worksheet.GetFirstChild<SheetData>();
        //        LobjSheetData.Descendants<DocumentFormat.OpenXml.Spreadsheet.Column>().Count();
        //        IEnumerable<DocumentFormat.OpenXml.Spreadsheet.Row> LobjRows = LobjSheetData.Descendants<DocumentFormat.OpenXml.Spreadsheet.Row>();
        //        Dictionary<string, string> LobjColumns = new Dictionary<string, string>();
        //        foreach (DocumentFormat.OpenXml.Spreadsheet.Cell LobjCell in LobjRows.ElementAt(0))
        //        {
        //            string LsColumn = GetCellValue(LobjSpreadsheetDocument, LobjCell);
        //            LobjDataTable.Columns.Add(LsColumn);
        //            if (LobjCell.CellReference != null)
        //                LobjColumns[LsColumn] = Regex.Replace(LobjCell.CellReference, "[0-9]", "");
        //        }
        //        foreach (DocumentFormat.OpenXml.Spreadsheet.Row LobjRow in LobjRows.Skip(1))
        //        {
        //            System.Data.DataRow LobjTempRow = LobjDataTable.NewRow();
        //            for (int LiCellIndex = 0; LiCellIndex < LobjRow.ChildElements.Count(); LiCellIndex++)
        //            {
        //                DocumentFormat.OpenXml.Spreadsheet.Cell LobjCell = LobjRow.Descendants<DocumentFormat.OpenXml.Spreadsheet.Cell>().ElementAt(LiCellIndex);
        //                string LsCellReferene = Regex.Replace(LobjCell.CellReference, "[0-9]", "");
        //                while (LiCellIndex <= LobjDataTable.Columns.Count && !LsCellReferene.Equals(LobjColumns.ElementAt(LiCellIndex).Value))
        //                {
        //                    LobjTempRow[LiCellIndex++] = string.Empty;
        //                }
        //                LobjTempRow[LiCellIndex] = GetCellValue(LobjSpreadsheetDocument, LobjCell);
        //            }
        //            LobjDataTable.Rows.Add(LobjTempRow);
        //        }
        //    }
        //    return LobjDataTable;
        //}

        private void button1_Click(object sender, EventArgs e)
        {
            OpenFileDialog ofd = new OpenFileDialog();
            string LobjvalideFolder = @"D:\Timesheetfolders\ValideFile\";
            string LobjINvalideFolder = @"D:\Timesheetfolders\Notvalidefile\";
            ofd.Filter = "Excell File |*.xlsx;*,xlsx";
            if (ofd.ShowDialog() == DialogResult.OK)
            {
                string extn = Path.GetExtension(ofd.FileName);
                if (extn.Equals(".xls") || extn.Equals(".xlsx"))
                {
                    LObjfilename = ofd.FileName;
                    if (LObjfilename != "")
                    {
                        string lobjStr = Path.GetFileName(LObjfilename);
                        PobjwbkWorkbook1 = Globals.ThisAddIn.Application.Workbooks.Open(lobjStr);
                        Microsoft.Office.Interop.Excel.Worksheet LobjactiveSheet = Globals.ThisAddIn.Application.ActiveSheet as Microsoft.Office.Interop.Excel.Worksheet;
                        LobjactiveSheet.Visible = Excel.XlSheetVisibility.xlSheetVisible;
                        var LCobj = LobjactiveSheet.Range["D3", Type.Missing].Value.Replace(" ", "");
                        var Dobj = LobjactiveSheet.Range["L3", Type.Missing].Text.Replace("/", "");
                        string Fnameobject = lobjStr.Replace(" ", "").Replace("-", "");
                        if (Fnameobject.Contains(LCobj) && Fnameobject.Contains(Dobj))
                        {
                            DateTime LObjDate;
                            LObjDate = dateTimePicker1.Value;
                            string LobjDatePickrr = LObjDate.ToString().Replace("/", "");
                            if (LobjDatePickrr.Contains(Dobj))
                            {
                                //test
                                var Lobjtoday = DateTime.Today;
                                var lobjmonth = new DateTime(Lobjtoday.Year, Lobjtoday.Month, 1);
                                string first = lobjmonth.AddMonths(-1).ToString("MM/dd/yy");
                                var LobjLastmonthdate = lobjmonth.AddDays(-1).ToString("MM/dd/yy");// last Monnth last date for validatting the curren 
                                var Dobjmon = LobjactiveSheet.Range["G7", Type.Missing].Text;
                                var Dobjtue = LobjactiveSheet.Range["H7", Type.Missing].Text;
                                var Dobjwen = LobjactiveSheet.Range["I7", Type.Missing].Text;
                                var Dobjthu = LobjactiveSheet.Range["J7", Type.Missing].Text;
                                var Dobjfri = LobjactiveSheet.Range["K7", Type.Missing].Text;
                                var lobjTotalBillableHours = LobjactiveSheet.Range["M17", Type.Missing].Value;
                                var lobjTotalNonBillableHours = LobjactiveSheet.Range["M29", Type.Missing].Value;
                                var LObjtotalHours = lobjTotalBillableHours + lobjTotalNonBillableHours;
                                //sum cell 
                                if (LobjLastmonthdate.Contains(Dobjmon))
                                {
                                    if (LObjtotalHours == 32)
                                    {
                                        File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                        System.Windows.Forms.MessageBox.Show("your Working Hours " + LObjtotalHours);
                                    }
                                    else
                                    {
                                        File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                                        System.Windows.Forms.MessageBox.Show(" your Working Hours " + LObjtotalHours);
                                    }
                                }
                                else if (LobjLastmonthdate.Contains(Dobjtue))
                                {
                                    if (LObjtotalHours == 24)
                                    {
                                        File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                        System.Windows.Forms.MessageBox.Show("your Working Hours " + LObjtotalHours);
                                    }
                                    else
                                    {
                                        File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                                        System.Windows.Forms.MessageBox.Show(" your Working Hours " + LObjtotalHours);
                                    }

                                }
                                else if (LobjLastmonthdate.Contains(Dobjwen))
                                {
                                    if (LObjtotalHours == 16)
                                    {
                                        File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                        System.Windows.Forms.MessageBox.Show("your Working Hours " + LObjtotalHours);
                                    }
                                    else
                                    {
                                        File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                                        System.Windows.Forms.MessageBox.Show(" your Working Hours " + LObjtotalHours);
                                    }

                                }
                                else if (LobjLastmonthdate.Contains(Dobjthu))
                                {
                                    if (LObjtotalHours == 8)
                                    {
                                        File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                        System.Windows.Forms.MessageBox.Show("your Working Hours " + LObjtotalHours);
                                    }
                                    else
                                    {
                                        File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                                        System.Windows.Forms.MessageBox.Show(" your Working Hours " + LObjtotalHours);
                                    }

                                }
                                else if (LobjLastmonthdate.Contains(Dobjfri))
                                {
                                    if (LObjtotalHours == 40)
                                    {
                                        File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                        System.Windows.Forms.MessageBox.Show("your Working Hours " + LObjtotalHours);
                                    }
                                    else
                                    {
                                        File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                                        System.Windows.Forms.MessageBox.Show(" your Working Hours " + LObjtotalHours);
                                    }
                                }
                                else if (!LobjLastmonthdate.Contains(Dobjmon) | !LobjLastmonthdate.Contains(Dobjtue) || !LobjLastmonthdate.Contains(Dobjwen) || !LobjLastmonthdate.Contains(Dobjthu) || !LobjLastmonthdate.Contains(Dobjfri))
                                {
                                    if (LObjtotalHours == 40)
                                    {
                                        File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                        System.Windows.Forms.MessageBox.Show("your Working Hours " + LObjtotalHours);
                                    }
                                    else
                                    {
                                        File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                                        System.Windows.Forms.MessageBox.Show(" your Working Hours " + LObjtotalHours);
                                    }
                                }
                                else
                                {
                                    File.Copy(lobjStr, LobjvalideFolder + Path.GetFileName(lobjStr));
                                }

                            }
                            else
                            {
                                File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                            }
                        }
                        else
                        {
                            File.Copy(lobjStr, LobjINvalideFolder + Path.GetFileName(lobjStr));
                        }

                    }

                }
            }

            //valide();
            //INvalide();
        }
        public void valide()
        {
            DirectoryInfo LobjDirectory = new DirectoryInfo(@"D:\Timesheetfolders\ValideFile");//Assuming Test is your Folder
            FileInfo[] LobjFiles = LobjDirectory.GetFiles("*.xlsx"); //Getting Text files
            int LobjvFileCount = 0;
            foreach (FileInfo LobjVfile in LobjFiles)
            {
                LobjvFileCount++;
                textBox2.Text = "";
                textBox2.Text += LobjvFileCount;
            }
        }
        public void INvalide()
        {
            DirectoryInfo LobjDirectory = new DirectoryInfo(@"D:\Timesheetfolders\Notvalidefile");//Assuming Test is your Folder
            FileInfo[] LobjFiles = LobjDirectory.GetFiles("*.xlsx"); //Getting Text files
            int LobjINvFileCount = 0;
            foreach (FileInfo LobjVfile in LobjFiles)
            {
                LobjINvFileCount++;
                textBox3.Text = "";
                textBox3.Text += LobjINvFileCount;


            }
        }

        private void button3_Click(object sender, EventArgs e)
        {
            validefilecollection();
        }
    }
}



